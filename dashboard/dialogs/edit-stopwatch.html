<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="import" href="components/paper-button/paper-button.html">
    <link rel="import" href="components/paper-input/paper-input.html">
    <link rel="import" href="components/iron-flex-layout/classes/iron-flex-layout.html">
    <link rel="import" href="elements/time-only-validator.html">
    <style>
        .buttons {
            padding-bottom: 0!important;
            padding-right: 0!important;
        }
    </style>
</head>
<body>
    <!-- Initialize the "time-only" validator so that we may use it -->
    <time-only></time-only>

    <paper-input id="edit" label="Time" validator="time-only" auto-validate
                 error-message="Should be formatted as HH:MM:SS"></paper-input>

    <div class="buttons">
        <paper-button dialog-dismiss autofocus>Close</paper-button>
        <paper-button id="save" on-tap="tapSave">Save</paper-button>
    </div>

    <script>
        var title = document.querySelector('h2');
        var saveButton = document.getElementById('save');
        var editInput = document.getElementById('edit');
        var stopwatchIndex;

        editInput.addEventListener('iron-input-validate', function(e) {
            // e.target.validity.valid seems to be busted. Use this workaround.
            var isValid = !e.target.hasAttribute('invalid');
            if (isValid) {
                saveButton.removeAttribute('disabled');
            } else {
                saveButton.setAttribute('disabled', 'true');
            }
        });

        saveButton.addEventListener('click', function() {
            if (editInput.validate()) {
                var ts = editInput.value.split(':');
                var ms = Date.UTC(1970, 0, 1, ts[0], ts[1], ts[2]);

                saveButton.setAttribute('disabled', 'true');
                nodecg.sendMessage('setTime', {index: stopwatchIndex, ms: ms}, function() {
                    window.frameElement.parentNode.close();
                    saveButton.removeAttribute('disabled');
                });
            }
        });

        window.setInfo = function(time, name, index) {
            editInput.value = time;
            title.innerText = 'Edit ' + name + '\'s Stopwatch';
            stopwatchIndex = index;
        }
    </script>
</body>
</html>
